#!/usr/bin/env node

const { spawn } = require('child_process')
const BinWrapper = require('bin-wrapper')
 
const BASEURL = 'https://github.com/featurepeek/peek/releases/download/'
const VERSION = '0.6.6'

const bin = new BinWrapper()
  .src(`${BASEURL}/v${VERSION}/peek_${VERSION}_macOS_amd64.tar.gz`, 'darwin', 'x64')
  .src(`${BASEURL}/v${VERSION}/peek_${VERSION}_Linux_amd64.tar.gz`, 'linux', 'x64')
  .src(`${BASEURL}/v${VERSION}/peek_${VERSION}_Linux_i386.tar.gz`, 'linux', 'x86')
  .src(`${BASEURL}/v${VERSION}/peek_${VERSION}_Windows_amd64.zip`, 'win32', 'x64')
  .src(`${BASEURL}/v${VERSION}/peek_${VERSION}_Windows_i386.zip`, 'win32', 'x86')
  .dest(`${__dirname}/vendor`)
  .use(process.platform === 'win32' ? 'peek.exe' : 'peek')
  .version(`>=${VERSION}`)
 
async function main () {
  // bin.run doesn't actually run the executable -- it only downloads it
  await bin.run()

  // process.argv produces something like 
  // [
  //   '~/.nvm/versions/node/v12.16.2/bin/node',
  //   '~/Sites/featurepeek/peek.js',
  //   '--version',
  //   '--help'
  // ]
  // so we slice off the first two since we're only interested in what follows
  const args = process.argv.slice(2)

  // escape spaces in the path
  const path = bin.path().replace(/ /g, '\\ ')

  // spawn process
  spawn(path, args, { stdio: 'inherit', shell: true })
}

main()
